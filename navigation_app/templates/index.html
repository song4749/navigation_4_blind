<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- ìºì‹œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ ë©”íƒ€ íƒœê·¸ ì¶”ê°€ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ì‹œê°ì¥ì• ì¸ìš© ë³´í–‰ì ë‚´ë¹„ê²Œì´ì…˜ & ì‹¤ì‹œê°„ íƒì§€</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <style>
    video, img {
      max-width: 100%;
      height: auto;
      box-sizing: border-box;
    }
  
    .screen {
      display: none;
      text-align: center;
    }
  
    .screen video,
    .screen img {
      margin: 0 auto;
    }
    #big-voice-input {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background-color: #FF0000;
      color: white;
      position: fixed;
      bottom: 50%;
      left: 50%;
      transform: translate(-50%, 50%);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      border: none;
      box-shadow: 0 6px 25px rgba(0,0,0,0.6);
      transition: all 0.3s ease;
    }
    #big-voice-input i {
      font-size: 70px;
    }
    #big-voice-input:hover {
      transform: translate(-50%, 50%) scale(1.05);
      background-color: #E91E63;
    }
    #big-voice-input:active {
      transform: translate(-50%, 50%) scale(0.95);
    }
    #big-voice-input.voice-recording {
      background-color: #f44336;
      animation: pulse-recording 1.5s infinite;
    }
    @keyframes pulse-recording {
      0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.6); }
      70% { box-shadow: 0 0 0 15px rgba(244, 67, 54, 0); }
      100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
    }
    .full-width-button {
      width: 100%;
      margin-left: 0;
      text-align: center;
      background-color: #9c27b0;
    }
    .full-width-button:hover {
      background-color: #7b1fa2;
    }
    #go-to-detection i, #go-to-detection-nav i {
      margin-right: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ ì˜ì—­ (ë³€ê²½ ì—†ìŒ) -->
  <div id="navigation-view" style="display: block;">
    <div id="app">
      <div id="map"></div>
      <div id="map-controls">
        <button id="center-map" aria-label="í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™" title="í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™">
          <i class="fas fa-location-arrow"></i>
        </button>
        <button id="toggle-panel" aria-label="íŒ¨ë„ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°" title="íŒ¨ë„ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°">
          <i class="fas fa-chevron-up"></i>
        </button>
      </div>
      <button id="big-voice-input" aria-label="ìŒì„±ìœ¼ë¡œ ëª©ì ì§€ ê²€ìƒ‰" title="ìŒì„±ìœ¼ë¡œ ëª©ì ì§€ ê²€ìƒ‰">
        <i class="fas fa-microphone"></i>
      </button>
      <div id="navigation-panel" class="expanded">
        <div id="status">í˜„ì¬ ìœ„ì¹˜ë¥¼ í™•ì¸ ì¤‘...</div>
        <div id="destination-form">
          <h3>ëª©ì ì§€ ì„¤ì •</h3>
          <div class="form-group">
            <label for="destination">ëª©ì ì§€:</label>
            <div class="input-with-voice">
              <input type="text" id="destination" placeholder="ëª©ì ì§€ ê²€ìƒ‰ (ì˜ˆ: ì„œìš¸ì—­, ê´‘í™”ë¬¸)">
              <button id="voice-input" title="ìŒì„±ìœ¼ë¡œ ëª©ì ì§€ ì…ë ¥">
                <i class="fas fa-microphone"></i>
              </button>
            </div>
            <button id="search">ê²€ìƒ‰</button>
          </div>
          <div class="radius-filter">
            <label for="search-radius">ê²€ìƒ‰ ë°˜ê²½:</label>
            <select id="search-radius">
              <option value="500">500m</option>
              <option value="1000" selected>1km</option>
              <option value="3000">3km</option>
              <option value="5000">5km</option>
            </select>
          </div>
          <div id="search-results" style="display: none;"></div>
          <div class="form-group">
            <!-- ë‚´ë¹„ê²Œì´ì…˜ ì‹œì‘ ì‹œ ì‹¤ì‹œê°„ íƒì§€ë„ í•¨ê»˜ ì‹œì‘ -->
            <button id="start-navigation">ê¸¸ ì•ˆë‚´ ì‹œì‘</button>
          </div>
          <div class="tip-container">
            <div class="tip"><div class="marker-icon current"></div> í˜„ì¬ ìœ„ì¹˜</div>
            <div class="tip"><div class="marker-icon destination"></div> ëª©ì ì§€</div>
          </div>
          <div class="form-group">
            <button onclick="showDetection()" style="font-size: 16px; padding: 10px 16px; width: 100%; margin-top: 10px;">
              ì‹¤ì‹œê°„ íƒì§€ í™”ë©´ ì´ë™
            </button>
          </div>
        </div>
        <div id="navigation-info" style="display: none;">
          <div class="info-item"><span class="label">ë‚¨ì€ ê±°ë¦¬:</span><span id="distance">0m</span></div>
          <div class="info-item"><span class="label">ì˜ˆìƒ ì‹œê°„:</span><span id="time">00:00:00</span></div>
          <div class="info-item"><span class="label">ë‹¤ìŒ ì•ˆë‚´:</span><span id="next-direction">ì§„í–‰ ì¤‘...</span></div>
          <div class="button-group">
            <button id="toggle-voice">ìŒì„± ë„ê¸°</button>
            <button id="read-instruction">ì§€ì‹œ ë‹¤ì‹œ ì½ê¸°</button>
            <button id="stop-navigation">ì•ˆë‚´ ì¢…ë£Œ</button>
          </div>
          <div class="form-group">
            <button onclick="showDetection()" style="font-size: 16px; padding: 10px 16px; width: 100%; margin-top: 10px;">
              ì‹¤ì‹œê°„ íƒì§€ í™”ë©´ ì´ë™
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì‹œê°„ íƒì§€ ì‹œìŠ¤í…œ ì˜ì—­: ì™¼ìª½ì—ëŠ” í•­ìƒ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë°, ì˜¤ë¥¸ìª½ì€ ì²˜ë¦¬ ê²°ê³¼ê°€ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ -->
  <div id="detection-view" style="display: none;">
    <div class="detection-container" style="display: flex; flex-direction: row; align-items: flex-start;">
      <!-- ì™¼ìª½: ì›ë³¸ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë° -->
      <div class="left-pane" style="flex: 1; padding: 10px; opacity: 0; pointer-events: none; position: absolute; left: 0; top: 0;">
        <video id="video" autoplay playsinline muted width="640" height="640" style="border:1px solid black;"></video>
      </div>
      <!-- ì˜¤ë¥¸ìª½: ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ í™”ë©´ ì „í™˜ë˜ë©° ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹  -->
      <div class="right-pane" style="flex: 1; padding: 10px;">
        <h1>ì‹¤ì‹œê°„ íƒì§€ ì‹œìŠ¤í…œ</h1>
        <button onclick="showNavigation()" style="font-size: 16px; padding: 8px 16px; margin-bottom: 20px; background-color: #eee; border-radius: 6px; border: 1px solid #ccc;">
          â† ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </button>
        <div id="screen-selector" style="margin-bottom: 20px;">
          <button onclick="switchScreen('original')">ì›ë³¸ í™”ë©´</button>
          <button onclick="switchScreen('depth')">ê¹Šì´ í™”ë©´</button>
          <button onclick="switchScreen('obstacle')">ì¥ì• ë¬¼ íƒì§€ í™”ë©´</button>
          <button onclick="switchScreen('segmentation')">ì„¸ê·¸ë©˜í…Œì´ì…˜ í™”ë©´</button>
        </div>
        <div id="screen-container">
          <!-- ì˜¤ë¥¸ìª½ ì›ë³¸ í™”ë©´ (ë¹„êµìš©) -->
          <div id="screen-original" class="screen" style="display: block;">
            <video id="video-original" autoplay playsinline muted width="640" height="640" style="border:1px solid black;"></video>
          </div>
          <!-- ê¹Šì´ í™”ë©´ -->
          <div id="screen-depth" class="screen" style="display: none;">
            <img id="depthmap" width="640" height="640" style="border:1px solid gray;" alt="Depth Map Visualization">
          </div>
          <!-- ì¥ì• ë¬¼ íƒì§€ í™”ë©´ -->
          <div id="screen-obstacle" class="screen" style="display: none;">
            <img id="obstaclemap" width="640" height="640" style="border:1px solid gray;" alt="Obstacle Detection">
          </div>
          <!-- ì„¸ê·¸ë©˜í…Œì´ì…˜ í™”ë©´ -->
          <div id="screen-segmentation" class="screen" style="display: none;">
            <img id="segmentationmap" width="640" height="640" style="border:1px solid gray;" alt="Segmentation Visualization">
          </div>
        </div>
        <h2>ê²½ê³  ë©”ì‹œì§€</h2>
        <div id="warnings" style="font-size:20px; color:red;"></div>
      </div>
    </div>
  </div>

  <script>
    const API_KEY = "{{ api_key }}";
    let currentDetectionScreen = "original";
    let navigationActive = false;
    let detectionStarted = false;
  
    document.getElementById("start-navigation").addEventListener("click", function () {
      if (!detectionStarted) {
        startDetection();
        detectionStarted = true;
      }
      navigationActive = true;
    });
  
    document.getElementById("stop-navigation").addEventListener("click", function () {
      navigationActive = false;
      const video = document.getElementById("video");
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
    });
  
    function showDetection() {
      document.getElementById("detection-view").style.display = "block";
      document.getElementById("navigation-view").style.display = "none";
    }
  
    function showNavigation() {
      document.getElementById("detection-view").style.display = "none";
      document.getElementById("navigation-view").style.display = "block";
    }
  
    function switchScreen(screen) {
      currentDetectionScreen = screen;
      document.getElementById("screen-original").style.display = (screen === "original") ? "block" : "none";
      document.getElementById("screen-depth").style.display = (screen === "depth") ? "block" : "none";
      document.getElementById("screen-obstacle").style.display = (screen === "obstacle") ? "block" : "none";
      document.getElementById("screen-segmentation").style.display = (screen === "segmentation") ? "block" : "none";
    }
  
    async function startDetection() {
      const video = document.getElementById("video");
      const videoOriginal = document.getElementById("video-original");
      const warningsDiv = document.getElementById("warnings");
      const depthImg = document.getElementById("depthmap");
      const obstacleImg = document.getElementById("obstaclemap");
      const segmentationImg = document.getElementById("segmentationmap");
  
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: 640,
            height: 640,
            facingMode: "environment"
          }
        });
        video.srcObject = stream;
        if (videoOriginal) {
          videoOriginal.srcObject = stream;
        }
      } catch (err) {
        console.error("ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:", err);
        return;
      }
  
      // âœ… 1. 0.2ì´ˆë§ˆë‹¤ íƒì§€ ìš”ì²­ ë³´ë‚´ê¸° (íƒì§€ëŠ” ë¬´ì¡°ê±´ ì£¼ê¸°ì ìœ¼ë¡œ)
      setInterval(() => {
        if (!navigationActive) return;
        sendFrame(video, warningsDiv);
      }, 200);
  
      async function updateImage(imgElement, url) {
        try {
          const response = await fetch(url, { cache: "no-store" });
          const blob = await response.blob();
          const objectURL = URL.createObjectURL(blob);
          imgElement.src = objectURL;
        } catch (err) {
          console.warn("ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        }
      }

      setInterval(() => {
        const now = Date.now();
        if (currentDetectionScreen === "depth") {
          updateImage(document.getElementById("depthmap"), `/static/depthmap_latest.jpg?t=${now}`);
        }
        if (currentDetectionScreen === "obstacle") {
          updateImage(document.getElementById("obstaclemap"), `/static/obstacle_latest.jpg?t=${now}`);
        }
        if (currentDetectionScreen === "segmentation") {
          updateImage(document.getElementById("segmentationmap"), `/static/segmentation_latest.jpg?t=${now}`);
        }
      }, 300);  // âœ… ì£¼ê¸°ë¥¼ 0.3ì´ˆë¡œ ì¤„ì„
    }
  
    async function sendFrame(video, warningsDiv) {
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = 640;
      tempCanvas.height = 640;
      const tempCtx = tempCanvas.getContext("2d");
      tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
  
      tempCanvas.toBlob(async blob => {
        const formData = new FormData();
        formData.append("file", blob, "frame.jpg");
  
        try {
          const screenParam = currentDetectionScreen;
          const response = await fetch(`/process_warning?screen=${screenParam}`, {
            method: "POST",
            body: formData,
            cache: "no-store"
          });
          const data = await response.json();
  
          warningsDiv.innerHTML = data.warnings.join("<br>");
          if (data.audio_url && typeof enqueueMp3 === 'function') {
              enqueueMp3(data.audio_url);
          }
  
          // ğŸ” ì´ë¯¸ì§€ ê°±ì‹ ì€ ë”°ë¡œ ëŒê¸° ë•Œë¬¸ì— ì—¬ê¸°ì„  ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
  
        } catch (err) {
          console.error("í”„ë ˆì„ ì „ì†¡ ì˜¤ë¥˜:", err);
        }
      }, "image/jpeg");
    }
  </script>
  <script type="module" src="/static/js/main.js"></script>
</body>
</html>
